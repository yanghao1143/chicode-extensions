name: Compile Priority Extensions

on:
  workflow_dispatch:
  schedule:
    # æ¯å‘¨ä¸€ UTC 0:00 è‡ªåŠ¨ç¼–è¯‘
    - cron: '0 0 * * 1'

env:
  RUST_TARGET: wasm32-wasip2

jobs:
  compile-priority:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2

      - name: Cache WASI SDK
        id: cache-wasi-sdk
        uses: actions/cache@v4
        with:
          path: ~/.wasi-sdk
          key: wasi-sdk-25-linux

      - name: Download WASI SDK
        if: steps.cache-wasi-sdk.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.wasi-sdk
          curl -L "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-25/wasi-sdk-25.0-x86_64-linux.tar.gz" | \
            tar -xz -C ~/.wasi-sdk --strip-components=1

      - name: Generate priority list
        run: node scripts/generate-index.js

      - name: Compile priority extensions
        run: |
          export WASI_SDK_PATH="$HOME/.wasi-sdk"
          export CC="${WASI_SDK_PATH}/bin/clang"
          export AR="${WASI_SDK_PATH}/bin/ar"

          mkdir -p dist

          # è¯»å–ä¼˜å…ˆæ‰©å±•åˆ—è¡¨
          PRIORITY_EXTS=$(cat priority-extensions.json | jq -r '.[]')

          for ext_id in $PRIORITY_EXTS; do
            echo "=========================================="
            echo "Processing: $ext_id"
            echo "=========================================="

            # åˆå§‹åŒ– submodule
            git submodule update --init --depth 1 "extensions/$ext_id" || {
              echo "Failed to init submodule for $ext_id, skipping..."
              continue
            }

            cd "extensions/$ext_id"

            # æ£€æŸ¥ extension.toml æ˜¯å¦å­˜åœ¨
            if [ ! -f "extension.toml" ]; then
              echo "No extension.toml found, skipping..."
              cd ../..
              continue
            fi

            # ç¼–è¯‘ Rust æ‰©å±•
            if [ -f "Cargo.toml" ]; then
              echo "Compiling Rust extension..."
              cargo build --release --target wasm32-wasip2 2>&1 || {
                echo "Cargo build failed for $ext_id"
                cd ../..
                continue
              }

              # æŸ¥æ‰¾ wasm æ–‡ä»¶
              WASM_FILE=$(find target/wasm32-wasip2/release -name "*.wasm" -type f 2>/dev/null | head -1)
              if [ -n "$WASM_FILE" ]; then
                cp "$WASM_FILE" extension.wasm
                echo "Created extension.wasm"
              fi
            fi

            # æ‰“åŒ…
            cd ..
            mkdir -p "../dist/$ext_id"
            cp -r "$ext_id/extension.toml" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/extension.wasm" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/languages" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/themes" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/grammars" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/snippets" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/icon.png" "../dist/$ext_id/" 2>/dev/null || true

            cd ../dist
            tar -czf "${ext_id}.tar.gz" "$ext_id"
            rm -rf "$ext_id"
            echo "Created ${ext_id}.tar.gz"

            cd ..
            echo ""
          done

      - name: Generate release index
        run: |
          cd dist

          # ä¸­æ–‡æè¿°æ˜ å°„
          declare -A descriptions
          descriptions["catppuccin"]="ğŸ¨ Catppuccin ä¸»é¢˜ - æŸ”å’Œçš„ç²‰å½©é…è‰²æ–¹æ¡ˆ"
          descriptions["dart"]="ğŸ¯ Dart è¯­è¨€æ”¯æŒ - Flutter å¼€å‘å¿…å¤‡"
          descriptions["dockerfile"]="ğŸ³ Dockerfile è¯­æ³•é«˜äº®å’Œæ”¯æŒ"
          descriptions["dracula"]="ğŸ§› Dracula ä¸»é¢˜ - ç»å…¸æš—è‰²ä¸»é¢˜"
          descriptions["elixir"]="ğŸ’§ Elixir è¯­è¨€æ”¯æŒ - å‡½æ•°å¼ç¼–ç¨‹"
          descriptions["git-firefly"]="ğŸ”¥ Git Firefly ä¸»é¢˜"
          descriptions["java"]="â˜• Java è¯­è¨€æ”¯æŒ - ä¼ä¸šçº§å¼€å‘"
          descriptions["kotlin"]="ğŸ¯ Kotlin è¯­è¨€æ”¯æŒ - ç°ä»£ Android å¼€å‘"
          descriptions["lua"]="ğŸŒ™ Lua è¯­è¨€æ”¯æŒ - æ¸¸æˆè„šæœ¬å¼€å‘"
          descriptions["make"]="ğŸ”§ Makefile è¯­æ³•æ”¯æŒ"
          descriptions["nord"]="â„ï¸ Nord ä¸»é¢˜ - åŒ—æé£æ ¼é…è‰²"
          descriptions["php"]="ğŸ˜ PHP è¯­è¨€æ”¯æŒ - Web åç«¯å¼€å‘"
          descriptions["ruby"]="ğŸ’ Ruby è¯­è¨€æ”¯æŒ - Rails å¼€å‘"
          descriptions["scala"]="âš¡ Scala è¯­è¨€æ”¯æŒ - å¤§æ•°æ®å¼€å‘"
          descriptions["sql"]="ğŸ—ƒï¸ SQL è¯­æ³•é«˜äº®æ”¯æŒ"
          descriptions["swift"]="ğŸ Swift è¯­è¨€æ”¯æŒ - iOS/macOS å¼€å‘"
          descriptions["toml"]="ğŸ“„ TOML é…ç½®æ–‡ä»¶æ”¯æŒ"
          descriptions["html"]="ğŸŒ HTML è¯­è¨€æ”¯æŒ"

          # ä¸­æ–‡åç§°æ˜ å°„
          declare -A names
          names["catppuccin"]="Catppuccin ä¸»é¢˜"
          names["dart"]="Dart è¯­è¨€"
          names["dockerfile"]="Dockerfile"
          names["dracula"]="Dracula ä¸»é¢˜"
          names["elixir"]="Elixir è¯­è¨€"
          names["git-firefly"]="Git Firefly"
          names["java"]="Java è¯­è¨€"
          names["kotlin"]="Kotlin è¯­è¨€"
          names["lua"]="Lua è¯­è¨€"
          names["make"]="Makefile"
          names["nord"]="Nord ä¸»é¢˜"
          names["php"]="PHP è¯­è¨€"
          names["ruby"]="Ruby è¯­è¨€"
          names["scala"]="Scala è¯­è¨€"
          names["sql"]="SQL"
          names["swift"]="Swift è¯­è¨€"
          names["toml"]="TOML"
          names["html"]="HTML"

          cat > index.json << 'JSONEOF'
{
  "version": 2,
  "generated_at": "TIMESTAMP_PLACEHOLDER",
  "repository": "https://github.com/yanghao1143/chicode-extensions",
  "extensions": [
JSONEOF

          sed -i "s/TIMESTAMP_PLACEHOLDER/$(date -Iseconds)/" index.json

          first=true
          for f in *.tar.gz; do
            [ -f "$f" ] || continue
            ext_id="${f%.tar.gz}"

            # ä»æ‰©å±•çš„ extension.toml è·å– repository
            repo_url=""
            ext_dir="../extensions/$ext_id"
            if [ -f "$ext_dir/extension.toml" ]; then
              repo_url=$(grep "^repository" "$ext_dir/extension.toml" 2>/dev/null | head -1 | cut -d'"' -f2 || echo "")
            fi

            # ä» .gitmodules è·å–
            if [ -z "$repo_url" ] && [ -f "../.gitmodules" ]; then
              repo_url=$(grep -A2 "extensions/$ext_id\]" ../.gitmodules 2>/dev/null | grep "url" | cut -d'=' -f2 | tr -d ' ' || echo "")
            fi

            # é»˜è®¤å€¼
            if [ -z "$repo_url" ]; then
              repo_url="https://github.com/yanghao1143/chicode-extensions"
            fi

            # è·å–ä¸­æ–‡æè¿°å’Œåç§°
            desc="${descriptions[$ext_id]:-Chi Code æ‰©å±•: $ext_id}"
            name="${names[$ext_id]:-$ext_id}"

            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> index.json
            fi
            echo -n "    {\"id\": \"$ext_id\", \"name\": \"$name\", \"description\": \"$desc\", \"repository\": \"$repo_url\", \"priority\": true}" >> index.json
          done

          echo "" >> index.json
          echo "  ]" >> index.json
          echo "}" >> index.json

          echo ""
          echo "Generated index.json:"
          cat index.json

      - name: Create or Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ›å»ºæˆ–æ›´æ–° release
          if gh release view extensions-latest > /dev/null 2>&1; then
            echo "Release exists, updating..."
            gh release edit extensions-latest \
              --title "Chi Code Extensions (Latest)" \
              --notes "## Chi Code æ‰©å±•åŒ… (è‡ªåŠ¨ç¼–è¯‘)

          æ›´æ–°æ—¶é—´: $(date -Iseconds)

          ### ä½¿ç”¨æ–¹æ³•

          ä¸‹è½½å•ä¸ªæ‰©å±•:
          \`\`\`
          https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/{id}.tar.gz
          \`\`\`

          è·å–ç´¢å¼•:
          \`\`\`
          https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/index.json
          \`\`\`"
          else
            echo "Creating new release..."
            gh release create extensions-latest \
              --title "Chi Code Extensions (Latest)" \
              --notes "## Chi Code æ‰©å±•åŒ… (è‡ªåŠ¨ç¼–è¯‘)

          æ›´æ–°æ—¶é—´: $(date -Iseconds)

          ### ä½¿ç”¨æ–¹æ³•

          ä¸‹è½½å•ä¸ªæ‰©å±•:
          \`\`\`
          https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/{id}.tar.gz
          \`\`\`

          è·å–ç´¢å¼•:
          \`\`\`
          https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/index.json
          \`\`\`"
          fi

      - name: Upload Release Assets with Retry
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd dist

          # ä¸Šä¼ å‡½æ•°ï¼Œå¸¦æŒ‡æ•°é€€é¿é‡è¯•
          upload_with_retry() {
            local file="$1"
            local max_retries=5
            local retry=0

            while [ $retry -lt $max_retries ]; do
              echo "Uploading $file (attempt $((retry+1))/$max_retries)..."

              # å…ˆåˆ é™¤å·²å­˜åœ¨çš„åŒåæ–‡ä»¶
              gh release delete-asset extensions-latest "$file" --yes 2>/dev/null || true

              # å°è¯•ä¸Šä¼ 
              if gh release upload extensions-latest "$file" --clobber; then
                echo "âœ“ Successfully uploaded $file"
                return 0
              fi

              retry=$((retry+1))
              if [ $retry -lt $max_retries ]; then
                local wait_time=$((2**retry))
                echo "Upload failed. Waiting ${wait_time}s before retry..."
                sleep $wait_time
              fi
            done

            echo "âœ— Failed to upload $file after $max_retries attempts"
            return 1
          }

          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
          failed_uploads=0
          for file in *.tar.gz index.json; do
            [ -f "$file" ] || continue
            if ! upload_with_retry "$file"; then
              failed_uploads=$((failed_uploads+1))
            fi
            # æ¯æ¬¡ä¸Šä¼ åç­‰å¾…1ç§’ï¼Œé¿å…è§¦å‘é€Ÿç‡é™åˆ¶
            sleep 1
          done

          if [ $failed_uploads -gt 0 ]; then
            echo "Warning: $failed_uploads file(s) failed to upload"
            exit 1
          fi

          echo "All files uploaded successfully!"
