name: Compile Priority Extensions

on:
  workflow_dispatch:
  schedule:
    # 每周一 UTC 0:00 自动编译
    - cron: '0 0 * * 1'

env:
  RUST_TARGET: wasm32-wasip2

jobs:
  compile-priority:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: wasm32-wasip2

      - name: Cache WASI SDK
        id: cache-wasi-sdk
        uses: actions/cache@v4
        with:
          path: ~/.wasi-sdk
          key: wasi-sdk-25-linux

      - name: Download WASI SDK
        if: steps.cache-wasi-sdk.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.wasi-sdk
          curl -L "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-25/wasi-sdk-25.0-x86_64-linux.tar.gz" | \
            tar -xz -C ~/.wasi-sdk --strip-components=1

      - name: Generate priority list
        run: node scripts/generate-index.js

      - name: Compile priority extensions
        run: |
          export WASI_SDK_PATH="$HOME/.wasi-sdk"
          export CC="${WASI_SDK_PATH}/bin/clang"
          export AR="${WASI_SDK_PATH}/bin/ar"

          mkdir -p dist

          # 读取优先扩展列表
          PRIORITY_EXTS=$(cat priority-extensions.json | jq -r '.[]')

          for ext_id in $PRIORITY_EXTS; do
            echo "=========================================="
            echo "Processing: $ext_id"
            echo "=========================================="

            # 初始化 submodule
            git submodule update --init --depth 1 "extensions/$ext_id" || {
              echo "Failed to init submodule for $ext_id, skipping..."
              continue
            }

            cd "extensions/$ext_id"

            # 检查 extension.toml 是否存在
            if [ ! -f "extension.toml" ]; then
              echo "No extension.toml found, skipping..."
              cd ../..
              continue
            fi

            # 编译 Rust 扩展
            if [ -f "Cargo.toml" ]; then
              echo "Compiling Rust extension..."
              cargo build --release --target wasm32-wasip2 2>&1 || {
                echo "Cargo build failed for $ext_id"
                cd ../..
                continue
              }

              # 查找 wasm 文件
              WASM_FILE=$(find target/wasm32-wasip2/release -name "*.wasm" -type f 2>/dev/null | head -1)
              if [ -n "$WASM_FILE" ]; then
                cp "$WASM_FILE" extension.wasm
                echo "Created extension.wasm"
              fi
            fi

            # 打包
            cd ..
            mkdir -p "../dist/$ext_id"
            cp -r "$ext_id/extension.toml" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/extension.wasm" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/languages" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/themes" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/grammars" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/snippets" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/icon.png" "../dist/$ext_id/" 2>/dev/null || true

            cd ../dist
            tar -czf "${ext_id}.tar.gz" "$ext_id"
            rm -rf "$ext_id"
            echo "Created ${ext_id}.tar.gz"

            cd ..
            echo ""
          done

      - name: Generate release index
        run: |
          cd dist

          # 读取 extensions.toml 获取仓库信息
          cat > index.json << 'JSONEOF'
          {
            "version": 2,
            "generated_at": "TIMESTAMP_PLACEHOLDER",
            "repository": "https://github.com/yanghao1143/chicode-extensions",
            "extensions": [
          JSONEOF

          # 替换时间戳
          sed -i "s/TIMESTAMP_PLACEHOLDER/$(date -Iseconds)/" index.json

          first=true
          for f in *.tar.gz; do
            [ -f "$f" ] || continue
            ext_id="${f%.tar.gz}"

            # 从原仓库的 extensions.toml 获取 repository 信息
            repo_url=""
            if [ -f "../extensions.toml" ]; then
              repo_url=$(grep -A5 "^\[${ext_id}\]" ../extensions.toml 2>/dev/null | grep "repository" | cut -d'"' -f2 || echo "")
            fi

            # 如果没找到，使用默认格式
            if [ -z "$repo_url" ]; then
              repo_url="https://github.com/zed-industries/zed"
            fi

            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> index.json
            fi
            echo -n "    {\"id\": \"$ext_id\", \"repository\": \"$repo_url\", \"priority\": true}" >> index.json
          done

          echo "" >> index.json
          echo "  ]" >> index.json
          echo "}" >> index.json

          echo ""
          echo "Generated index.json:"
          cat index.json

      - name: Create or Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 创建或更新 release
          if gh release view extensions-latest > /dev/null 2>&1; then
            echo "Release exists, updating..."
            gh release edit extensions-latest \
              --title "Chi Code Extensions (Latest)" \
              --notes "## Chi Code 扩展包 (自动编译)

          更新时间: $(date -Iseconds)

          ### 使用方法

          下载单个扩展:
          \`\`\`
          https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/{id}.tar.gz
          \`\`\`

          获取索引:
          \`\`\`
          https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/index.json
          \`\`\`"
          else
            echo "Creating new release..."
            gh release create extensions-latest \
              --title "Chi Code Extensions (Latest)" \
              --notes "## Chi Code 扩展包 (自动编译)

          更新时间: $(date -Iseconds)

          ### 使用方法

          下载单个扩展:
          \`\`\`
          https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/{id}.tar.gz
          \`\`\`

          获取索引:
          \`\`\`
          https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/index.json
          \`\`\`"
          fi

      - name: Upload Release Assets with Retry
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd dist

          # 上传函数，带指数退避重试
          upload_with_retry() {
            local file="$1"
            local max_retries=5
            local retry=0

            while [ $retry -lt $max_retries ]; do
              echo "Uploading $file (attempt $((retry+1))/$max_retries)..."

              # 先删除已存在的同名文件
              gh release delete-asset extensions-latest "$file" --yes 2>/dev/null || true

              # 尝试上传
              if gh release upload extensions-latest "$file" --clobber; then
                echo "✓ Successfully uploaded $file"
                return 0
              fi

              retry=$((retry+1))
              if [ $retry -lt $max_retries ]; then
                local wait_time=$((2**retry))
                echo "Upload failed. Waiting ${wait_time}s before retry..."
                sleep $wait_time
              fi
            done

            echo "✗ Failed to upload $file after $max_retries attempts"
            return 1
          }

          # 上传所有文件
          failed_uploads=0
          for file in *.tar.gz index.json; do
            [ -f "$file" ] || continue
            if ! upload_with_retry "$file"; then
              failed_uploads=$((failed_uploads+1))
            fi
            # 每次上传后等待1秒，避免触发速率限制
            sleep 1
          done

          if [ $failed_uploads -gt 0 ]; then
            echo "Warning: $failed_uploads file(s) failed to upload"
            exit 1
          fi

          echo "All files uploaded successfully!"
