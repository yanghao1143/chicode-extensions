name: Compile All Extensions

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of extensions per batch'
        required: false
        default: '50'
  schedule:
    # æ¯æœˆ1æ—¥ UTC 0:00 è‡ªåŠ¨ç¼–è¯‘
    - cron: '0 0 1 * *'

env:
  RUST_TARGET: wasm32-wasip2

jobs:
  # ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆæ‰©å±•åˆ—è¡¨
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      total: ${{ steps.set-matrix.outputs.total }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Generate extension batches
        id: set-matrix
        run: |
          # è·å–æ‰€æœ‰æ‰©å±• ID
          EXTENSIONS=$(grep "^\[submodule" .gitmodules | sed 's/.*extensions\///' | sed 's/"\]//' | sort)
          TOTAL=$(echo "$EXTENSIONS" | wc -l)
          echo "Total extensions: $TOTAL"
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # åˆ†æ‰¹
          BATCH_SIZE=${{ github.event.inputs.batch_size || '50' }}
          BATCHES=()
          BATCH_NUM=0
          COUNT=0
          CURRENT_BATCH=""

          for ext in $EXTENSIONS; do
            if [ $COUNT -ge $BATCH_SIZE ]; then
              BATCHES+=("$BATCH_NUM")
              echo "BATCH_${BATCH_NUM}=${CURRENT_BATCH}" >> $GITHUB_ENV
              BATCH_NUM=$((BATCH_NUM + 1))
              COUNT=0
              CURRENT_BATCH=""
            fi
            if [ -n "$CURRENT_BATCH" ]; then
              CURRENT_BATCH="${CURRENT_BATCH},${ext}"
            else
              CURRENT_BATCH="${ext}"
            fi
            COUNT=$((COUNT + 1))
          done

          # æœ€åä¸€æ‰¹
          if [ -n "$CURRENT_BATCH" ]; then
            BATCHES+=("$BATCH_NUM")
            echo "BATCH_${BATCH_NUM}=${CURRENT_BATCH}" >> $GITHUB_ENV
          fi

          # è¾“å‡ºçŸ©é˜µ
          MATRIX_JSON=$(printf '%s\n' "${BATCHES[@]}" | jq -R . | jq -s '{batch: .}')
          echo "matrix=${MATRIX_JSON}" >> $GITHUB_OUTPUT
          echo "Matrix: ${MATRIX_JSON}"

          # ä¿å­˜æ‰¹æ¬¡åˆ°æ–‡ä»¶
          mkdir -p batches
          BATCH_NUM=0
          COUNT=0
          CURRENT_BATCH=""
          for ext in $EXTENSIONS; do
            if [ $COUNT -ge $BATCH_SIZE ]; then
              echo "$CURRENT_BATCH" > "batches/batch_${BATCH_NUM}.txt"
              BATCH_NUM=$((BATCH_NUM + 1))
              COUNT=0
              CURRENT_BATCH=""
            fi
            if [ -n "$CURRENT_BATCH" ]; then
              CURRENT_BATCH="${CURRENT_BATCH}
          ${ext}"
            else
              CURRENT_BATCH="${ext}"
            fi
            COUNT=$((COUNT + 1))
          done
          if [ -n "$CURRENT_BATCH" ]; then
            echo "$CURRENT_BATCH" > "batches/batch_${BATCH_NUM}.txt"
          fi

      - name: Upload batches
        uses: actions/upload-artifact@v4
        with:
          name: extension-batches
          path: batches/

  # ç¬¬äºŒæ­¥ï¼šå¹¶è¡Œç¼–è¯‘å„æ‰¹æ¬¡
  compile:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Download batches
        uses: actions/download-artifact@v4
        with:
          name: extension-batches
          path: batches/

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2

      - name: Cache WASI SDK
        id: cache-wasi-sdk
        uses: actions/cache@v4
        with:
          path: ~/.wasi-sdk
          key: wasi-sdk-25-linux

      - name: Download WASI SDK
        if: steps.cache-wasi-sdk.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.wasi-sdk
          curl -L "https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-25/wasi-sdk-25.0-x86_64-linux.tar.gz" | \
            tar -xz -C ~/.wasi-sdk --strip-components=1

      - name: Compile batch ${{ matrix.batch }}
        run: |
          export WASI_SDK_PATH="$HOME/.wasi-sdk"
          export CC="${WASI_SDK_PATH}/bin/clang"
          export AR="${WASI_SDK_PATH}/bin/ar"

          mkdir -p dist
          BATCH_FILE="batches/batch_${{ matrix.batch }}.txt"

          if [ ! -f "$BATCH_FILE" ]; then
            echo "Batch file not found: $BATCH_FILE"
            exit 0
          fi

          while IFS= read -r ext_id || [ -n "$ext_id" ]; do
            [ -z "$ext_id" ] && continue
            echo "=========================================="
            echo "Processing: $ext_id"
            echo "=========================================="

            # åˆå§‹åŒ– submodule
            git submodule update --init --depth 1 "extensions/$ext_id" 2>/dev/null || {
              echo "Failed to init submodule for $ext_id, skipping..."
              continue
            }

            cd "extensions/$ext_id" 2>/dev/null || {
              echo "Directory not found for $ext_id, skipping..."
              cd ../..
              continue
            }

            # æ£€æŸ¥ extension.toml
            if [ ! -f "extension.toml" ]; then
              echo "No extension.toml found, skipping..."
              cd ../..
              continue
            fi

            # ç¼–è¯‘ Rust æ‰©å±•ï¼ˆé™æ—¶5åˆ†é’Ÿï¼‰
            if [ -f "Cargo.toml" ]; then
              echo "Compiling Rust extension..."
              timeout 300 cargo build --release --target wasm32-wasip2 2>&1 || {
                echo "Cargo build failed or timeout for $ext_id"
                cd ../..
                continue
              }

              WASM_FILE=$(find target/wasm32-wasip2/release -name "*.wasm" -type f 2>/dev/null | head -1)
              if [ -n "$WASM_FILE" ]; then
                cp "$WASM_FILE" extension.wasm
                echo "Created extension.wasm"
              fi
            fi

            # æ‰“åŒ…
            cd ..
            mkdir -p "../dist/$ext_id"
            cp -r "$ext_id/extension.toml" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/extension.wasm" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/languages" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/themes" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/grammars" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/snippets" "../dist/$ext_id/" 2>/dev/null || true
            cp -r "$ext_id/icon.png" "../dist/$ext_id/" 2>/dev/null || true

            cd ../dist
            tar -czf "${ext_id}.tar.gz" "$ext_id" 2>/dev/null && {
              rm -rf "$ext_id"
              echo "Created ${ext_id}.tar.gz"
            }
            cd ..
          done < "$BATCH_FILE"

      - name: Upload compiled extensions
        uses: actions/upload-artifact@v4
        with:
          name: extensions-batch-${{ matrix.batch }}
          path: dist/*.tar.gz
          if-no-files-found: ignore

  # ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶å¹¶å‘å¸ƒ
  release:
    needs: [prepare, compile]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Download all compiled extensions
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: extensions-batch-*
          merge-multiple: true

      - name: Prepare release
        run: |
          mkdir -p dist
          # ç§»åŠ¨æ‰€æœ‰ tar.gz åˆ° dist
          find artifacts/ -name "*.tar.gz" -exec mv {} dist/ \; 2>/dev/null || true

          echo "Compiled extensions:"
          ls -la dist/ | head -50
          echo "Total: $(ls dist/*.tar.gz 2>/dev/null | wc -l) extensions"

      - name: Generate index with Chinese descriptions
        run: |
          cd dist

          # ä¸‹è½½ä¸­æ–‡æè¿°æ–‡ä»¶
          cp ../descriptions-zh.json ./

          # ç”Ÿæˆ index.json
          cat > index.json << 'JSONEOF'
{
  "version": 2,
  "generated_at": "TIMESTAMP_PLACEHOLDER",
  "repository": "https://github.com/yanghao1143/chicode-extensions",
  "total_count": TOTAL_PLACEHOLDER,
  "extensions": [
JSONEOF

          sed -i "s/TIMESTAMP_PLACEHOLDER/$(date -Iseconds)/" index.json

          # è®¡æ•°
          TOTAL=0
          first=true

          for f in *.tar.gz; do
            [ -f "$f" ] || continue
            ext_id="${f%.tar.gz}"
            TOTAL=$((TOTAL + 1))

            # ä» descriptions-zh.json è·å–ä¸­æ–‡æè¿°
            name=$(jq -r ".extensions.\"$ext_id\".name // empty" descriptions-zh.json)
            desc=$(jq -r ".extensions.\"$ext_id\".desc // empty" descriptions-zh.json)

            # å¦‚æœæ²¡æœ‰é¢„å®šä¹‰ï¼Œè‡ªåŠ¨ç”Ÿæˆ
            if [ -z "$name" ]; then
              # ç¾åŒ–åç§°
              name=$(echo "$ext_id" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
            fi

            if [ -z "$desc" ]; then
              # æ ¹æ®æ‰©å±•ç±»å‹è‡ªåŠ¨ç”Ÿæˆæè¿°
              if echo "$ext_id" | grep -qi "theme"; then
                desc="ğŸ¨ ${name} ä¸»é¢˜"
              elif echo "$ext_id" | grep -qi "icon"; then
                desc="ğŸ¯ ${name} å›¾æ ‡ä¸»é¢˜"
              elif echo "$ext_id" | grep -qi "snippet"; then
                desc="ğŸ“‹ ${name} ä»£ç ç‰‡æ®µ"
              elif echo "$ext_id" | grep -qi "lsp\|language-server"; then
                desc="ğŸ”§ ${name} è¯­è¨€æœåŠ¡å™¨"
              elif echo "$ext_id" | grep -qi "lint\|check"; then
                desc="ğŸ” ${name} ä»£ç æ£€æŸ¥"
              elif echo "$ext_id" | grep -qi "format"; then
                desc="âœ¨ ${name} ä»£ç æ ¼å¼åŒ–"
              else
                desc="ğŸ“¦ ${name} æ‰©å±•"
              fi
            fi

            # è·å–ä»“åº“ URL
            repo_url=""
            if [ -f "../.gitmodules" ]; then
              repo_url=$(grep -A2 "extensions/$ext_id\]" ../.gitmodules 2>/dev/null | grep "url" | cut -d'=' -f2 | tr -d ' ' | sed 's/\.git$//' || echo "")
            fi
            if [ -z "$repo_url" ]; then
              repo_url="https://github.com/yanghao1143/chicode-extensions"
            fi

            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> index.json
            fi

            # è½¬ä¹‰ JSON ç‰¹æ®Šå­—ç¬¦
            desc_escaped=$(echo "$desc" | sed 's/"/\\"/g')
            name_escaped=$(echo "$name" | sed 's/"/\\"/g')

            echo -n "    {\"id\": \"$ext_id\", \"name\": \"$name_escaped\", \"description\": \"$desc_escaped\", \"repository\": \"$repo_url\", \"priority\": true}" >> index.json
          done

          echo "" >> index.json
          echo "  ]" >> index.json
          echo "}" >> index.json

          # æ›¿æ¢æ€»æ•°
          sed -i "s/TOTAL_PLACEHOLDER/$TOTAL/" index.json

          echo ""
          echo "Generated index.json with $TOTAL extensions"
          head -30 index.json

      - name: Create or Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd dist
          TOTAL=$(ls *.tar.gz 2>/dev/null | wc -l)

          if gh release view extensions-latest > /dev/null 2>&1; then
            echo "Deleting old release..."
            gh release delete extensions-latest --yes || true
          fi

          echo "Creating new release with $TOTAL extensions..."
          gh release create extensions-latest \
            --title "Chi Code Extensions (Latest) - $TOTAL ä¸ªæ‰©å±•" \
            --notes "## Chi Code æ‰©å±•åŒ… (è‡ªåŠ¨ç¼–è¯‘)

æ›´æ–°æ—¶é—´: $(date -Iseconds)
æ‰©å±•æ€»æ•°: **$TOTAL** ä¸ª

### ä½¿ç”¨æ–¹æ³•

Chi Code ä¼šè‡ªåŠ¨ä»æ­¤å¤„è·å–æ‰©å±•åˆ—è¡¨ã€‚

### æ‰‹åŠ¨ä¸‹è½½

ä¸‹è½½å•ä¸ªæ‰©å±•:
\`\`\`
https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/{id}.tar.gz
\`\`\`

è·å–ç´¢å¼•:
\`\`\`
https://github.com/yanghao1143/chicode-extensions/releases/download/extensions-latest/index.json
\`\`\`"

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd dist

          # å…ˆä¸Šä¼  index.json
          echo "Uploading index.json..."
          gh release upload extensions-latest index.json --clobber

          # æ‰¹é‡ä¸Šä¼ æ‰©å±•åŒ…
          echo "Uploading extension packages..."
          FAILED=0
          for f in *.tar.gz; do
            [ -f "$f" ] || continue
            echo "Uploading $f..."
            if ! gh release upload extensions-latest "$f" --clobber; then
              echo "Failed to upload $f"
              FAILED=$((FAILED + 1))
              # é‡è¯•ä¸€æ¬¡
              sleep 2
              gh release upload extensions-latest "$f" --clobber || true
            fi
            # é¿å…é€Ÿç‡é™åˆ¶
            sleep 0.5
          done

          if [ $FAILED -gt 0 ]; then
            echo "Warning: $FAILED files failed to upload"
          fi

          echo "Upload complete!"
